<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหาบ้านในฝัน</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* CSS เฉพาะสำหรับหน้านี้ สามารถย้ายไปรวมใน styles.css ได้ */
        body { margin-top: 80px; } /* เพิ่มพื้นที่สำหรับ Nav Bar ที่เป็น fixed */
        .form-grid {
            display: grid;
            /* ทำให้ยืดหยุ่นบนหน้าจอขนาดต่างๆ */
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav>
        <a href="#" id="logoutButton">ออกจากระบบ</a>
        <select id="languageSelector">
            <option value="th">ไทย</option>
            <option value="en">English</option>
        </select>
    </nav>

    <div class="container">
        <h2>ค้นหาบ้านในฝัน</h2>
        <form id="searchForm">
            <div class="form-grid">
                <div class="input-group">
                    <label for="OverallQual">คุณภาพโดยรวม (1-10)</label>
                    <input type="number" id="OverallQual" name="OverallQual" min="1" max="10" required>
                </div>
                <div class="input-group">
                    <label for="GrLivArea">พื้นที่อยู่อาศัย (ตร.ฟุต)</label>
                    <input type="number" id="GrLivArea" name="GrLivArea" min="0" required>
                </div>
                <div class="input-group">
                    <label for="GarageCars">ความจุโรงรถ (คัน)</label>
                    <input type="number" id="GarageCars" name="GarageCars" min="0" required>
                </div>
                <div class="input-group">
                    <label for="TotalBsmtSF">พื้นที่ชั้นใต้ดิน (ตร.ฟุต)</label>
                    <input type="number" id="TotalBsmtSF" name="TotalBsmtSF" min="0" required>
                </div>
                 <div class="input-group">
                    <label for="FullBath">จำนวนห้องน้ำ</label>
                    <input type="number" id="FullBath" name="FullBath" min="0" required>
                </div>
                <div class="input-group">
                    <label for="YearBuilt">ปีที่สร้าง</label>
                    <input type="number" id="YearBuilt" name="YearBuilt" min="1800" max="2025" required>
                </div>
            </div>
            <button type="submit" class="btn" style="margin-top: 1.5rem;">ทำนายราคา</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ตรวจสอบสถานะ Login ---
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                alert('กรุณาเข้าสู่ระบบเพื่อใช้งาน');
                window.location.href = "{{ url_for('login_page') }}";
                return; // หยุดการทำงาน script ที่เหลือ
            }
            
            // --- จัดการปุ่ม Logout ---
            const logoutButton = document.getElementById('logoutButton');
            if(logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    alert('ออกจากระบบสำเร็จ');
                    window.location.href = "{{ url_for('login_page') }}";
                });
            }

            // --- จัดการฟอร์มค้นหา ---
            const searchForm = document.getElementById('searchForm');
            if(searchForm) {
                searchForm.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const user_id = localStorage.getItem("user_id");
                    if (!user_id) {
                        alert("เกิดข้อผิดพลาด: ไม่พบ User ID กรุณาล็อกอินใหม่อีกครั้ง");
                        return;
                    }

                    // --- รวบรวมข้อมูลจากฟอร์ม ---
                    const payload = {
                        user_id: user_id,
                        OverallQual: parseInt(document.getElementById('OverallQual').value),
                        GrLivArea: parseInt(document.getElementById('GrLivArea').value),
                        GarageCars: parseInt(document.getElementById('GarageCars').value),
                        TotalBsmtSF: parseInt(document.getElementById('TotalBsmtSF').value),
                        FullBath: parseInt(document.getElementById('FullBath').value),
                        YearBuilt: parseInt(document.getElementById('YearBuilt').value)
                        // **สำคัญ:** เพิ่มฟีเจอร์อื่นๆ ที่โมเดลของคุณต้องการที่นี่
                    };

                    // --- ใช้ Fetch API เพื่อส่งข้อมูลไปทำนายราคา ---
                    fetch("http://127.0.0.1:5000/api/predict", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.error || 'การทำนายราคาล้มเหลว') });
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.predicted_price !== undefined) {
                            // ส่งผลการทำนายไปที่หน้า results.html ผ่าน URL
                            window.location.href = `{{ url_for('results_page') }}?price=${data.predicted_price}`;
                        }
                    })
                    .catch(err => {
                        console.error("Prediction Error:", err);
                        alert(err.message);
                    });
                });
            }
        });
    </script>
</body>
</html>